<?xml version="1.0"?>
<system name="Wing Flapping">

  <property value="0">fcs/wing-pos-linear</property>
  <property value="-4.3">fcs/wing-asymmetry</property>

  <channel name="Wing Flapping">
<!--
   bind to: simulation/dt
   Speed up Flapping based on: fcs/throttle-pos-norm
-->
    <fcs_function name="Wing Flap Frequency Control">
      <function>
        <product name="Wing Flap Frequency Control">
          <property>simulation/dt</property>
          <property>fcs/throttle-pos-norm</property>
          <value>3.33</value>
        </product>
      </function>
      <output>fcs/wing-flap-advance</output>
    </fcs_function>

    <summer name="Wing Position Updater">
      <input>fcs/wing-pos-linear</input>
      <input>fcs/wing-flap-advance</input>
      <output>fcs/wing-pos-linear</output>
    </summer>

    <!-- Flapping motion: y = cos(x + 0.25*cos(0.75*x)) -->
    <pure_gain name="Wing Flap Motion Stage 1">
      <input>fcs/wing-pos-linear</input>
      <gain>0.75</gain>
      <output>fcs/wing-alpha-stage-1</output>
    </pure_gain>

    <fcs_function name="Wing Flap Motion Stage 2">
      <function>
        <product>
          <cos><property>fcs/wing-alpha-stage-1</property></cos>
          <value>0.25</value>
        </product>
      </function>
      <output>fcs/wing-alpha-stage-2</output>
    </fcs_function>

    <summer name="Wing Flap Motion Stage 3">
      <input>fcs/wing-alpha-stage-2</input>
      <input>fcs/wing-pos-linear</input>
      <output>fcs/wing-alpha-stage-3</output>
    </summer>

    <fcs_function name="Wing Flap Motion Control">
      <function>
        <product>
          <cos><property>fcs/wing-alpha-stage-3</property></cos>
          <property>fcs/throttle-pos-norm</property>
          <value>20.0</value>
        </product>
      </function>
      <output>fcs/wing-alpha-sym</output>
    </fcs_function>

    <fcs_function name="Asymmetry Control">
      <function>
        <product>
          <property>fcs/wing-asymmetry</property>
          <property>fcs/throttle-pos-norm</property>
        </product>
      </function>
      <output>fcs/wing-asym-corrected</output>
    </fcs_function>

    <summer>
      <input>-aero/alpha-deg</input>
      <input>fcs/wing-alpha-sym</input>
      <input>fcs/wing-asym-corrected</input>
      <output>fcs/wing-alpha-deg</output>
    </summer>

  </channel>
</system>
